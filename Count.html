<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>AI Typing Counter - Có thể bị phá!</title>
<style>
  body {
    background: #0d1117;
    color: #00ff99;
    font-family: monospace;
    font-size: 1.1rem;
    padding: 20px;
    margin: 0;
  }
  #console {
    white-space: pre-wrap;
    line-height: 1.4em;
  }
  .cursor {
    display: inline-block;
    width: 8px;
    background: #00ff99;
    margin-left: 2px;
    animation: blink 0.8s steps(2, start) infinite;
  }
  @keyframes blink { to { background: transparent; } }
  .typo { color: #00ff99; transition: color 5s linear; }
  .typo.red { color: red; }
</style>
</head>
<body>
<div id="console">AI bắt đầu đếm...\n</div><div class="cursor"></div>

<script>
const consoleEl = document.getElementById("console");
let num = 1;
let expectedText = "AI bắt đầu đếm...\n";

const specialChars = ["!", "*", "#", "~", "^", "?", "@", "$", "%"];
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playKeySound(f=400,d=0.03,v=0.1){
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type="square"; osc.frequency.value=f;
  gain.gain.value=v; osc.connect(gain); gain.connect(audioCtx.destination);
  osc.start(); osc.stop(audioCtx.currentTime+d);
}
function playTypeSound(){ playKeySound(500+Math.random()*200,0.04,0.05); }
function playBackspaceSound(){ playKeySound(200+Math.random()*100,0.05,0.07); }

// --- Người dùng có thể phá AI ---
document.addEventListener("keydown", (e) => {
  if (e.key.length === 1) {
    consoleEl.textContent += e.key;
    playTypeSound();
  } else if (e.key === "Backspace") {
    consoleEl.textContent = consoleEl.textContent.slice(0,-1);
    playBackspaceSound();
  }
  window.scrollTo(0, document.body.scrollHeight);
  checkAndFix();
});

// So khớp console với expected
function checkAndFix(){
  if(!consoleEl.textContent.startsWith(expectedText)){
    let common = 0;
    while(common<consoleEl.textContent.length &&
          common<expectedText.length &&
          consoleEl.textContent[common]===expectedText[common]){
      common++;
    }
    let toDelete = consoleEl.textContent.length - common;
    backspace(toDelete, () => {
      typeText(expectedText.slice(common));
    });
  }
}

// Backspace AI (xóa nhanh dần)
function backspace(count,callback){
  let deleted=0;
  function del(){
    if(count>0){
      consoleEl.textContent = consoleEl.textContent.slice(0,-1);
      playBackspaceSound();
      count--; deleted++;
      const delay = Math.max(20, 120 - deleted*5 + Math.random()*20);
      setTimeout(del,delay);
    } else if(callback){ callback(); }
  }
  del();
}

// Hiện tượng phát nổ (khi typo đỏ quá lâu)
function triggerExplosion(){
  const content = consoleEl.textContent;
  const len = content.length;
  const removeCount = Math.floor(len * (Math.random()*0.05)); // 0–5%
  consoleEl.textContent = content.slice(0,len-removeCount);
  expectedText = consoleEl.textContent; // đồng bộ lại
}

// Typo map cho gõ nhầm
const typoMap={"0":["9","-","p"],"1":["2","q"],"2":["1","3","w"],"3":["2","4","e"],
"4":["3","5","r"],"5":["4","6","t"],"6":["5","7","y"],"7":["6","8","u"],
"8":["7","9","i"],"9":["8","0","o"],",":[".","m","k"]};

function randomTypoChar(ch){ return typoMap[ch]? typoMap[ch][Math.floor(Math.random()*typoMap[ch].length)] : ch; }
function introduceTypos(text){
  let result=""; 
  const typoCount=Math.floor(Math.random()*2)+1;
  const indices=[];
  for(let i=0;i<typoCount;i++){indices.push(Math.floor(Math.random()*text.length));}
  for(let i=0;i<text.length;i++){result+=indices.includes(i)?randomTypoChar(text[i]):text[i];}
  return result;
}

function getRandomSpecialSuffix(){
  const count=Math.floor(Math.random()*3)+1;
  let suffix=""; for(let i=0;i<count;i++){suffix+=specialChars[Math.floor(Math.random()*specialChars.length)];}
  return suffix;
}

// --- Khung để bạn tự bổ sung quy tắc ăn mừng ---
function isSpecialNumber(num) {
    let celebrate = false;
    // TODO: bổ sung logic cho số đẹp (tròn 100, số nối, 69, tam số, v.v.)
    return celebrate;
}

function formatNumber(num){
  let textNum = num.toString();
  if(isSpecialNumber(num)){
      textNum += getRandomSpecialSuffix();
  }
  return textNum;
}

// AI gõ chữ
function typeText(text,callback,fast=false,isTypo=false){
  let i=0;
  function typing(){
    if(i<text.length){
      let char = text.charAt(i);
      if(isTypo){
        const span = document.createElement('span');
        span.className='typo';
        span.textContent = char;
        consoleEl.appendChild(span);
        setTimeout(()=>{
          span.classList.add('red');
          setTimeout(()=>{ if(consoleEl.contains(span)) triggerExplosion(); },5000);
        },0);
      } else {
        consoleEl.textContent += char;
      }
      expectedText += char; // luôn nhớ nội dung chuẩn
      playTypeSound();
      i++; 
      window.scrollTo(0,document.body.scrollHeight);
      setTimeout(typing, fast?5:(Math.random()*80+20));
    } else if(callback){ callback(); }
  }
  typing();
}

// Vòng lặp chính của AI
function loop(){
  const isBatch=Math.random()<0.15;
  const typoChance=isBatch?0.15:0.05;
  const willTypo = Math.random()<typoChance;

  if(isBatch){
    const batchSize=Math.floor(Math.random()*10)+5;
    let correctText="";
    for(let i=0;i<batchSize;i++){
      correctText+=formatNumber(num)+", ";
      num++;
    }
    if(willTypo){
      let wrongText=introduceTypos(correctText);
      typeText(wrongText,()=>{setTimeout(()=>{backspace(wrongText.length,()=>{typeText(correctText,()=>{setTimeout(loop,Math.random()*400+200)},true)})},300)},true,true);
    } else typeText(correctText,()=>{setTimeout(loop,Math.random()*400+200)},true);
  } else {
    let correctText=formatNumber(num)+", "; num++;
    if(willTypo){
      let wrongText=introduceTypos(correctText);
      typeText(wrongText,()=>{setTimeout(()=>{backspace(wrongText.length,()=>{typeText(correctText,()=>{setTimeout(loop,Math.random()*250+100)})})},300)},false,true);
    } else typeText(correctText,()=>{setTimeout(loop,Math.random()*200+50)});
  }
}

setTimeout(loop,1000);
</script>
</body>
</html>
